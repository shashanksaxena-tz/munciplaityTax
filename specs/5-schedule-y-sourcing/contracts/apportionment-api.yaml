openapi: 3.0.3
info:
  title: Apportionment API
  description: |
    REST API for multi-state income apportionment calculations (Schedule Y).
    Supports Joyce/Finnigan elections, throwback/throwout rules, market-based service sourcing,
    and four-factor apportionment formulas.
  version: 1.0.0
  contact:
    name: MuniTax Development Team

servers:
  - url: https://api.munitax.com/v1
    description: Production server
  - url: https://api-staging.munitax.com/v1
    description: Staging server
  - url: http://localhost:8080/api/v1
    description: Local development server

tags:
  - name: Apportionment
    description: Schedule Y apportionment calculations
  - name: Factors
    description: Property, payroll, and sales factor management
  - name: Nexus
    description: Nexus tracking for throwback determination
  - name: Audit
    description: Apportionment audit trail

paths:
  /apportionment/calculate:
    post:
      summary: Calculate apportionment factors and final percentage
      description: |
        Calculates property, payroll, and sales factors, applies sourcing rules
        (Joyce/Finnigan, throwback/throwout, market-based), and computes final
        apportionment percentage using configured formula.
      tags:
        - Apportionment
      operationId: calculateApportionment
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ApportionmentCalculationRequest'
      responses:
        '200':
          description: Apportionment calculated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApportionmentCalculationResponse'
        '400':
          description: Invalid request (validation errors)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized (missing or invalid JWT)
        '500':
          description: Internal server error

  /apportionment/{returnId}:
    get:
      summary: Get Schedule Y for a tax return
      description: |
        Retrieves all Schedule Y records (one per municipality) for a given tax return,
        including property/payroll/sales factors and calculation breakdown.
      tags:
        - Apportionment
      operationId: getScheduleY
      security:
        - bearerAuth: []
      parameters:
        - name: returnId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Tax return UUID
        - name: municipalityCode
          in: query
          required: false
          schema:
            type: string
          description: Filter by municipality code (e.g., "COLUMBUS", "DUBLIN")
      responses:
        '200':
          description: Schedule Y retrieved successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ScheduleYResponse'
        '404':
          description: Tax return not found
        '403':
          description: Forbidden (user does not have access to this return)

    put:
      summary: Update Schedule Y
      description: |
        Updates property, payroll, or sales factors for a Schedule Y.
        Logs changes to audit trail.
      tags:
        - Apportionment
      operationId: updateScheduleY
      security:
        - bearerAuth: []
      parameters:
        - name: returnId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ScheduleYUpdateRequest'
      responses:
        '200':
          description: Schedule Y updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ScheduleYResponse'
        '400':
          description: Validation errors
        '404':
          description: Schedule Y not found

  /apportionment/{returnId}/elections:
    put:
      summary: Update sourcing method elections
      description: |
        Updates Joyce/Finnigan election, throwback/throwout election, or
        service sourcing method (market-based vs cost-of-performance).
        Elections apply to entire Schedule Y.
      tags:
        - Apportionment
      operationId: updateElections
      security:
        - bearerAuth: []
      parameters:
        - name: returnId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ElectionUpdateRequest'
      responses:
        '200':
          description: Elections updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ScheduleYResponse'
        '400':
          description: Invalid election (not allowed by municipality rules)

  /apportionment/{returnId}/breakdown:
    get:
      summary: Get detailed factor breakdown
      description: |
        Returns line-by-line breakdown of apportionment calculation:
        - Property factor calculation with owned/rented property
        - Payroll factor calculation with W-2/contractor/officer comp
        - Sales factor calculation with transaction-level sourcing
        - Weighted formula showing factor weights and final percentage
      tags:
        - Apportionment
      operationId: getFactorBreakdown
      security:
        - bearerAuth: []
      parameters:
        - name: returnId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: municipalityCode
          in: query
          required: false
          schema:
            type: string
      responses:
        '200':
          description: Breakdown retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FactorBreakdownResponse'

  /apportionment/sales-transactions:
    post:
      summary: Add sale transaction
      description: |
        Adds individual sale transaction with sourcing details.
        System determines sourcing method (destination, market-based, throwback, etc.)
        based on sale type, customer location, and nexus status.
      tags:
        - Factors
      operationId: addSaleTransaction
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SaleTransactionRequest'
      responses:
        '201':
          description: Transaction added successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SaleTransactionResponse'
        '400':
          description: Validation errors

    get:
      summary: List sale transactions
      description: |
        Lists all sale transactions for a Schedule Y with filtering and pagination.
      tags:
        - Factors
      operationId: listSaleTransactions
      security:
        - bearerAuth: []
      parameters:
        - name: salesFactorId
          in: query
          required: true
          schema:
            type: string
            format: uuid
        - name: saleType
          in: query
          required: false
          schema:
            $ref: '#/components/schemas/SaleType'
        - name: sourcingMethod
          in: query
          required: false
          schema:
            $ref: '#/components/schemas/SourcingMethod'
        - name: page
          in: query
          required: false
          schema:
            type: integer
            default: 0
        - name: size
          in: query
          required: false
          schema:
            type: integer
            default: 50
      responses:
        '200':
          description: Transactions retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  transactions:
                    type: array
                    items:
                      $ref: '#/components/schemas/SaleTransactionResponse'
                  page:
                    type: integer
                  totalPages:
                    type: integer
                  totalElements:
                    type: integer

  /nexus/track:
    post:
      summary: Update nexus status for a state
      description: |
        Updates nexus tracking for a business in a specific state/municipality.
        Used to determine throwback eligibility.
      tags:
        - Nexus
      operationId: updateNexusStatus
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NexusStatusRequest'
      responses:
        '200':
          description: Nexus status updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NexusStatusResponse'

    get:
      summary: Get nexus status for a business
      description: |
        Retrieves nexus status for all states/municipalities where business operates.
      tags:
        - Nexus
      operationId: getNexusStatus
      security:
        - bearerAuth: []
      parameters:
        - name: businessId
          in: query
          required: true
          schema:
            type: string
            format: uuid
        - name: taxYear
          in: query
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Nexus status retrieved successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/NexusStatusResponse'

  /apportionment/{returnId}/audit-trail:
    get:
      summary: Get audit trail for Schedule Y
      description: |
        Retrieves all audit log entries for a Schedule Y, showing history of
        elections, factor changes, and calculation overrides.
      tags:
        - Audit
      operationId: getAuditTrail
      security:
        - bearerAuth: []
      parameters:
        - name: returnId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: changeType
          in: query
          required: false
          schema:
            $ref: '#/components/schemas/ChangeType'
        - name: page
          in: query
          required: false
          schema:
            type: integer
            default: 0
        - name: size
          in: query
          required: false
          schema:
            type: integer
            default: 50
      responses:
        '200':
          description: Audit trail retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  auditLogs:
                    type: array
                    items:
                      $ref: '#/components/schemas/AuditLogEntry'
                  page:
                    type: integer
                  totalPages:
                    type: integer

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    # Request/Response Schemas

    ApportionmentCalculationRequest:
      type: object
      required:
        - returnId
        - municipalityCode
        - taxYear
        - propertyFactor
        - payrollFactor
        - salesFactor
      properties:
        returnId:
          type: string
          format: uuid
        municipalityCode:
          type: string
          example: "COLUMBUS"
        taxYear:
          type: integer
          example: 2024
        propertyFactor:
          $ref: '#/components/schemas/PropertyFactorInput'
        payrollFactor:
          $ref: '#/components/schemas/PayrollFactorInput'
        salesFactor:
          $ref: '#/components/schemas/SalesFactorInput'
        elections:
          $ref: '#/components/schemas/ElectionInput'

    ApportionmentCalculationResponse:
      type: object
      properties:
        scheduleYId:
          type: string
          format: uuid
        returnId:
          type: string
          format: uuid
        municipalityCode:
          type: string
        taxYear:
          type: integer
        propertyFactorPercentage:
          type: number
          format: double
          example: 0.2500
        payrollFactorPercentage:
          type: number
          format: double
          example: 0.4286
        salesFactorPercentage:
          type: number
          format: double
          example: 0.5000
        finalApportionmentPercentage:
          type: number
          format: double
          example: 0.4072
        apportionmentFormula:
          $ref: '#/components/schemas/ApportionmentFormula'
        elections:
          $ref: '#/components/schemas/Elections'
        calculatedDate:
          type: string
          format: date-time

    ScheduleYResponse:
      allOf:
        - $ref: '#/components/schemas/ApportionmentCalculationResponse'
        - type: object
          properties:
            propertyFactor:
              $ref: '#/components/schemas/PropertyFactorOutput'
            payrollFactor:
              $ref: '#/components/schemas/PayrollFactorOutput'
            salesFactor:
              $ref: '#/components/schemas/SalesFactorOutput'

    ScheduleYUpdateRequest:
      type: object
      properties:
        municipalityCode:
          type: string
        propertyFactor:
          $ref: '#/components/schemas/PropertyFactorInput'
        payrollFactor:
          $ref: '#/components/schemas/PayrollFactorInput'
        salesFactor:
          $ref: '#/components/schemas/SalesFactorInput'
        changeReason:
          type: string
          description: Reason for update (required for auditor overrides)

    ElectionUpdateRequest:
      type: object
      properties:
        municipalityCode:
          type: string
        sourcingMethodElection:
          $ref: '#/components/schemas/SourcingMethodElection'
        throwbackElection:
          $ref: '#/components/schemas/ThrowbackElection'
        serviceSourcingMethod:
          $ref: '#/components/schemas/ServiceSourcingMethod'
        changeReason:
          type: string

    FactorBreakdownResponse:
      type: object
      properties:
        municipalityCode:
          type: string
        propertyBreakdown:
          type: object
          properties:
            ohioRealProperty:
              type: number
              format: double
            ohioTangiblePersonalProperty:
              type: number
              format: double
            ohioRentedPropertyValue:
              type: number
              format: double
            totalOhioProperty:
              type: number
              format: double
            totalPropertyEverywhere:
              type: number
              format: double
            factorPercentage:
              type: number
              format: double
            weight:
              type: number
              example: 1
        payrollBreakdown:
          type: object
          properties:
            ohioW2Wages:
              type: number
              format: double
            ohioContractorPayments:
              type: number
              format: double
            ohioOfficerCompensation:
              type: number
              format: double
            totalOhioPayroll:
              type: number
              format: double
            totalPayrollEverywhere:
              type: number
              format: double
            factorPercentage:
              type: number
              format: double
            weight:
              type: number
              example: 1
        salesBreakdown:
          type: object
          properties:
            ohioSalesTangibleGoods:
              type: number
              format: double
            ohioSalesServices:
              type: number
              format: double
            ohioSalesOther:
              type: number
              format: double
            throwbackAdjustment:
              type: number
              format: double
            totalOhioSales:
              type: number
              format: double
            totalSalesEverywhere:
              type: number
              format: double
            factorPercentage:
              type: number
              format: double
            weight:
              type: number
              example: 2
        formula:
          type: object
          properties:
            type:
              $ref: '#/components/schemas/ApportionmentFormula'
            calculation:
              type: string
              example: "(0.2500 × 1 + 0.4286 × 1 + 0.5000 × 2) / 4 = 0.4072"
            finalApportionmentPercentage:
              type: number
              format: double

    # Factor Inputs

    PropertyFactorInput:
      type: object
      required:
        - totalPropertyEverywhere
        - beginningOfYearValue
        - endOfYearValue
      properties:
        ohioRealProperty:
          type: number
          format: double
          example: 2000000.00
        ohioTangiblePersonalProperty:
          type: number
          format: double
          example: 500000.00
        ohioAnnualRent:
          type: number
          format: double
          example: 100000.00
        totalPropertyEverywhere:
          type: number
          format: double
          example: 10000000.00
        averagingMethod:
          $ref: '#/components/schemas/AveragingMethod'
        beginningOfYearValue:
          type: number
          format: double
        endOfYearValue:
          type: number
          format: double
        monthlyValues:
          type: object
          additionalProperties:
            type: number
            format: double

    PropertyFactorOutput:
      allOf:
        - $ref: '#/components/schemas/PropertyFactorInput'
        - type: object
          properties:
            propertyFactorId:
              type: string
              format: uuid
            ohioRentedPropertyValue:
              type: number
              format: double
            totalOhioProperty:
              type: number
              format: double
            propertyFactorPercentage:
              type: number
              format: double

    PayrollFactorInput:
      type: object
      required:
        - totalPayrollEverywhere
      properties:
        ohioW2Wages:
          type: number
          format: double
          example: 3000000.00
        ohioContractorPayments:
          type: number
          format: double
          example: 500000.00
        ohioOfficerCompensation:
          type: number
          format: double
          example: 200000.00
        totalPayrollEverywhere:
          type: number
          format: double
          example: 7000000.00
        employeeCountTotal:
          type: integer
          example: 50
        employeeCountOhio:
          type: integer
          example: 30
        remoteEmployeeAllocation:
          type: object
          additionalProperties:
            type: number
            format: double
          example:
            OH: 3500000
            CA: 2000000
            NY: 1500000

    PayrollFactorOutput:
      allOf:
        - $ref: '#/components/schemas/PayrollFactorInput'
        - type: object
          properties:
            payrollFactorId:
              type: string
              format: uuid
            totalOhioPayroll:
              type: number
              format: double
            payrollFactorPercentage:
              type: number
              format: double

    SalesFactorInput:
      type: object
      required:
        - totalSalesEverywhere
      properties:
        ohioSalesTangibleGoods:
          type: number
          format: double
        ohioSalesServices:
          type: number
          format: double
        ohioSalesRentalIncome:
          type: number
          format: double
        ohioSalesInterest:
          type: number
          format: double
        ohioSalesRoyalties:
          type: number
          format: double
        ohioSalesOther:
          type: number
          format: double
        totalSalesEverywhere:
          type: number
          format: double
          example: 10000000.00

    SalesFactorOutput:
      allOf:
        - $ref: '#/components/schemas/SalesFactorInput'
        - type: object
          properties:
            salesFactorId:
              type: string
              format: uuid
            throwbackAdjustment:
              type: number
              format: double
            totalOhioSales:
              type: number
              format: double
            salesFactorPercentage:
              type: number
              format: double

    ElectionInput:
      type: object
      properties:
        sourcingMethodElection:
          $ref: '#/components/schemas/SourcingMethodElection'
        throwbackElection:
          $ref: '#/components/schemas/ThrowbackElection'
        serviceSourcingMethod:
          $ref: '#/components/schemas/ServiceSourcingMethod'

    Elections:
      allOf:
        - $ref: '#/components/schemas/ElectionInput'

    # Sale Transactions

    SaleTransactionRequest:
      type: object
      required:
        - salesFactorId
        - transactionDate
        - customerName
        - saleAmount
        - saleType
        - originState
        - destinationState
      properties:
        salesFactorId:
          type: string
          format: uuid
        transactionDate:
          type: string
          format: date
        customerName:
          type: string
        customerLocationState:
          type: string
          pattern: '^[A-Z]{2}$'
        saleAmount:
          type: number
          format: double
        saleType:
          $ref: '#/components/schemas/SaleType'
        originState:
          type: string
          pattern: '^[A-Z]{2}$'
        destinationState:
          type: string
          pattern: '^[A-Z]{2}$'
        serviceAllocationDetails:
          type: object
          additionalProperties:
            type: number
            format: double

    SaleTransactionResponse:
      allOf:
        - $ref: '#/components/schemas/SaleTransactionRequest'
        - type: object
          properties:
            transactionId:
              type: string
              format: uuid
            sourcingMethod:
              $ref: '#/components/schemas/SourcingMethod'
            hasDestinationNexus:
              type: boolean
            allocatedState:
              type: string
            allocatedAmount:
              type: number
              format: double
            throwbackReason:
              type: string

    # Nexus Tracking

    NexusStatusRequest:
      type: object
      required:
        - businessId
        - taxYear
        - stateCode
      properties:
        businessId:
          type: string
          format: uuid
        taxYear:
          type: integer
        stateCode:
          type: string
          pattern: '^[A-Z]{2}$'
        municipalityName:
          type: string
        salesInState:
          type: number
          format: double
        propertyInState:
          type: number
          format: double
        payrollInState:
          type: number
          format: double
        employeeCountInState:
          type: integer

    NexusStatusResponse:
      allOf:
        - $ref: '#/components/schemas/NexusStatusRequest'
        - type: object
          properties:
            nexusId:
              type: string
              format: uuid
            hasNexus:
              type: boolean
            nexusReasons:
              type: array
              items:
                $ref: '#/components/schemas/NexusReason'
            economicNexusThreshold:
              type: number
              format: double
            lastEvaluatedDate:
              type: string
              format: date-time

    # Audit Trail

    AuditLogEntry:
      type: object
      properties:
        auditLogId:
          type: string
          format: uuid
        scheduleYId:
          type: string
          format: uuid
        changeType:
          $ref: '#/components/schemas/ChangeType'
        changedBy:
          type: string
          format: uuid
        userRole:
          $ref: '#/components/schemas/UserRole'
        changeDate:
          type: string
          format: date-time
        oldValue:
          type: object
        newValue:
          type: object
        changeReason:
          type: string
        affectedCalculation:
          type: string

    # Enums

    ApportionmentFormula:
      type: string
      enum:
        - TRADITIONAL_THREE_FACTOR
        - FOUR_FACTOR_DOUBLE_SALES
        - SINGLE_SALES_FACTOR
        - CUSTOM

    SourcingMethodElection:
      type: string
      enum:
        - FINNIGAN
        - JOYCE

    ThrowbackElection:
      type: string
      enum:
        - THROWBACK
        - THROWOUT
        - NONE

    ServiceSourcingMethod:
      type: string
      enum:
        - MARKET_BASED
        - COST_OF_PERFORMANCE

    SaleType:
      type: string
      enum:
        - TANGIBLE_GOODS
        - SERVICES
        - RENTAL_INCOME
        - INTEREST
        - ROYALTIES
        - OTHER

    SourcingMethod:
      type: string
      enum:
        - DESTINATION
        - MARKET_BASED
        - COST_OF_PERFORMANCE
        - THROWBACK
        - THROWOUT

    AveragingMethod:
      type: string
      enum:
        - AVERAGE_BEGINNING_ENDING
        - MONTHLY_AVERAGE
        - DAILY_AVERAGE

    NexusReason:
      type: string
      enum:
        - PHYSICAL_PRESENCE
        - ECONOMIC_NEXUS
        - FACTOR_PRESENCE

    ChangeType:
      type: string
      enum:
        - ELECTION_CHANGED
        - FACTOR_RECALCULATED
        - TRANSACTION_ADDED
        - TRANSACTION_MODIFIED
        - NEXUS_CHANGED
        - CALCULATION_OVERRIDE

    UserRole:
      type: string
      enum:
        - INDIVIDUAL
        - CPA
        - AUDITOR
        - ADMIN

    # Error Response

    ErrorResponse:
      type: object
      properties:
        timestamp:
          type: string
          format: date-time
        status:
          type: integer
        error:
          type: string
        message:
          type: string
        path:
          type: string
        validationErrors:
          type: array
          items:
            type: object
            properties:
              field:
                type: string
              message:
                type: string
